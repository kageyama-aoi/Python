<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MD 保存ツール</title>

  <style>
    :root {
      --bg: #f8f9fb;
      --panel: #ffffff;
      --border: #dcdfe4;
      --text: #1f2328;
      --sub: #6a737d;
      --primary: #0969da;
      --danger: #cf222e;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      max-width: 960px;
      margin: 0 auto;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    label {
      font-size: 14px;
    }

    input, textarea, button {
      font: inherit;
    }

    input {
      padding: 8px 10px;
      width: 280px;
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    textarea {
      width: 100%;
      height: 55vh;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      resize: vertical;
    }

    button {
      padding: 9px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
    }

    button.primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    button.danger {
      color: var(--danger);
      border-color: var(--danger);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .hint {
      font-size: 13px;
      color: var(--sub);
      margin-bottom: 12px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <div class="panel">
    <h1>MD 保存ツール</h1>

    <div class="row">
      <label>
        保存名（任意）<br>
        <input id="baseName" placeholder="空なら # 見出しから自動生成">
      </label>

      <button id="saveBtn" class="primary">MDとして保存</button>
      <button id="clearBtn" class="danger">入力をクリア</button>
    </div>

    <div class="hint">
      ファイル名は <span class="mono">YYYYMMDD_名前.md</span>（JST）<br>
      名前が空の場合は、先頭の <b># 見出し</b> を使用します。
    </div>

    <textarea id="md" placeholder="# タイトル&#10;&#10;ここに Markdown を貼り付け"></textarea>

    <div class="footer hint">
      <span id="charCount">0 文字</span>
      <span>※ 保存後も内容は保持されます</span>
    </div>
  </div>

  <script>
    const mdEl = document.getElementById("md");
    const baseNameEl = document.getElementById("baseName");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const charCountEl = document.getElementById("charCount");

    // JSTで YYYYMMDD
    function yyyymmddJST() {
      const now = new Date();
      const jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60 * 1000);
      return (
        jst.getFullYear() +
        String(jst.getMonth() + 1).padStart(2, "0") +
        String(jst.getDate()).padStart(2, "0")
      );
    }

    // 先頭の # 見出し取得
    function firstH1(md) {
      for (const line of md.split(/\r?\n/)) {
        const m = line.match(/^#\s+(.+)$/);
        if (m) return m[1].trim();
      }
      return "";
    }

    // ファイル名用整形
    function sanitizeName(name) {
      return (name || "")
        .replace(/[\\/:*?"<>|]/g, "")
        .replace(/\s+/g, "_")
        .replace(/_+/g, "_")
        .slice(0, 80)
        .trim() || "memo";
    }

    // 保存処理
    saveBtn.addEventListener("click", () => {
      const md = mdEl.value || "";
      const base = baseNameEl.value.trim() || firstH1(md) || "memo";
      const filename = `${yyyymmddJST()}_${sanitizeName(base)}.md`;

      const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // 入力クリア（誤操作防止）
    clearBtn.addEventListener("click", () => {
      if (!mdEl.value && !baseNameEl.value) return;
      if (!confirm("入力内容をすべてクリアします。よろしいですか？")) return;

      mdEl.value = "";
      baseNameEl.value = "";
      updateCount();
    });

    // 文字数カウント
    function updateCount() {
      charCountEl.textContent = `${mdEl.value.length} 文字`;
    }

    mdEl.addEventListener("input", updateCount);
    updateCount();
  </script>
</body>
</html>
