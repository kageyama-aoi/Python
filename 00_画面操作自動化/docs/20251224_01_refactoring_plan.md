# リファクタリング計画書

本ドキュメントは、`00_画面操作自動化` プロジェクトの現状分析と、将来的な汎用化（ひな形化）を見据えたリファクタリングの提案をまとめたものです。

## 1. 現状のアーキテクチャ分析

現在のコードベースは、以下の4つの主要なモジュールで構成されており、関心事の分離（Separation of Concerns）はある程度なされています。

| ファイル名 | 役割 | 分類 |
| :--- | :--- | :--- |
| `create_task_report.py` | 全体のフロー制御、初期化、ユーザー入力の受付 | **Orchestrator** |
| `task_report_input_handler.py` | 画面操作の具体的な手順（Plan）の構築と実行 | **Domain Logic** |
| `constants.py` | 画面項目のID定義、学校ごとのテンプレートデータ、設定 | **Data/Config** |
| `element_utils.py` | Seleniumコマンドのラッパー関数群 | **Utility** |

### 課題点

1.  **ロジックとデータの結合度が高い**:
    *   `task_report_input_handler.py` 内で、「この項目名なら `send`（入力）」、「この項目名なら `select`（選択）」といった判断が、項目名に対する条件分岐（if文）としてハードコーディングされています。
    *   これにより、新しい項目を追加する際にコードの修正が必要となり、データ（`constants.py`）を変更するだけでは完結しません。

2.  **ユーティリティの品質**:
    *   `element_utils.py` の関数名（例: `set`）が動作を表しておらず、可読性を下げています。
    *   内部実装にバグ（LinkTextを指定しているのに `By.NAME` を使用している等）が見受けられます。

3.  **拡張性の欠如**:
    *   テンプレートデータ（`SCHOOL_SPECIFIC_DEFAULTS`）がPythonコードとして定義されているため、非エンジニアによる修正や外部ファイル化が困難です。

---

## 2. リファクタリング提案

汎用的な「自動化ひな形」へ昇華させる前に、以下の3段階のリファクタリングを推奨します。

### Phase 1: ユーティリティ層の健全化 (`element_utils.py`)

足回りとなるSelenium操作部分を修正・整理します。

*   **関数名の変更**: 何をする関数か明確にします。
    *   `set` -> `find_element`
    *   `send` -> `input_text`
    *   `select` -> `select_option`
*   **バグ修正**: `find_element` 内での `By` 指定の誤りを修正します。
*   **型ヒントの追加**: 開発時の補完と安全性を高めます。

### Phase 2: データ構造の再設計 (`constants.py`)

「どう操作するか」という情報をコードからデータへ移します。

*   **フィールド定義の拡張**:
    *   現在の `TR_FIELD_MAPPINGS` は `項目名: ID/Name` の単純なマッピングです。
    *   これを `項目名: { 'locator': '...', 'type': 'text' | 'select' | 'radio' }` のような、操作タイプを含む構造に変更します。
*   これにより、ロジック側で「項目名」による条件分岐をする必要がなくなります。

### Phase 3: ロジックのデータドリブン化 (`task_report_input_handler.py`)

Phase 2のデータ構造変更に伴い、ロジックを簡素化します。

*   **条件分岐の削除**:
    *   「もし項目名が `status` なら `select` を呼ぶ」といったロジックを廃止します。
    *   代わりに「定義された `type` が `select` なら `select_option` を呼ぶ」という汎用的なロジックに変更します。
*   **汎用クラスへの昇華**:
    *   クラス名を `TaskReportInputHandler` から `FormAutomationHandler` などの汎用的な名前に変更し、タスクレポート固有の処理を排除します。

---

## 3. 次のステップ（汎用化・ひな形化）

上記のリファクタリング完了後、以下の手順で汎用化を行います。

1.  **設定の外部化**: `constants.py` の内容（特にテンプレートデータ）を `config.yaml` や `templates.json` などの外部ファイルに切り出します。
2.  **エントリーポイントの整理**: `create_task_report.py` を、外部設定ファイルを読み込んで動く汎用的なランナー (`main.py` 等) に変更します。
