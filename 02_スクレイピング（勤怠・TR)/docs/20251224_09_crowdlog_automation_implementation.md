# CrowdLog 自動化実装レポート

本ドキュメントは、CrowdLog工数実績ダウンロード自動化機能の実装内容と変更点をまとめたものです。

## 実装概要

CrowdLogの「工数実績エクスポート」画面から、当月の実績CSVを自動的にダウンロードし、指定フォルダへ格納する機能を実装しました。

### 主な機能

1.  **自動ログイン**: 未ログイン状態で実行した場合、自動的にログイン処理を行います。
2.  **期間自動入力**: 実行時の日付に基づき、今月の「1日」から「末日」を自動計算して入力します。
3.  **ダウンロード実行**: カレンダーポップアップ等の干渉を回避し、確実にダウンロードボタンをクリックします。
4.  **ファイル自動移動**: ダウンロードされたCSVファイルを検知し、所定のフォルダ（`data/downloads/`）へ移動します。

---

## 変更内容詳細

### 1. 設定ファイル (`config/config.yaml`)

*   **CrowdLog設定の追加**:
    *   `app.url`: ターゲットURLを設定。
    *   `app.login`: ログイン情報（Email/Password）のプレースホルダーを追加。
    *   `app.download_dir`: ダウンロードファイルの保存先を指定。
    *   `selectors`: ログイン画面およびダウンロード画面の各要素（Email, Password, ボタン等）のセレクタを追加。
    *   `fields.tr_field_mappings`: 日付入力フィールド (`StartDate`, `EndDate`) を追加。
    *   `school_specific_defaults`: `cl` (CrowdLog) パターンを定義し、動的日付プレースホルダーを設定。
*   **メニューの更新**: 実行時選択メニューに `cl:CrowdLog工数実績ダウンロード` を追加。

### 2. ソースコード

#### `src/form_handler.py`
*   **動的日付計算**: `_get_dynamic_dates` メソッドを追加し、実行日基準で月初・月末を算出。
*   **ログイン処理**: `_perform_login_if_needed` メソッドを追加。ログイン画面の表示を検知して自動ログインを実行。
*   **クリック処理の改善**: DatePickerの干渉によるクリックエラー（`ElementClickInterceptedException`）を防ぐため、`body`クリックによるフォーカス外しと、JavaScriptによる強制クリック処理を実装。

#### `src/main.py`
*   **初期動作の分岐**: CrowdLog (`cl`) 選択時は、タスクレポート用の「新規作成ボタン」クリックをスキップするよう修正。
*   **完了後処理**: ダウンロード完了後、`file_utils` を呼び出してファイルを移動する処理を追加。
*   **ウィンドウサイズ**: CrowdLogの画面レイアウトに合わせてウィンドウサイズを調整。

#### `src/file_utils.py` (新規作成)
*   ダウンロードフォルダを監視し、最新のCSVファイルをターゲットディレクトリへ移動する `move_latest_downloaded_file` 関数を実装。

#### `src/browser_utils.py`
*   `find_element` 関数に `css` セレクタ（`By.CSS_SELECTOR`）のサポートを追加。

---

## 使用方法

1.  **設定**: `config/config.yaml` の `app.login` セクションに、正しいログイン情報を設定してください。
2.  **実行**:
    ```bash
    python src/main.py
    ```
3.  **選択**: メニューで `cl` を入力し Enter キーを押します。

## トラブルシューティング

*   **ログインできない**: `config.yaml` のメールアドレスとパスワードが正しいか確認してください。
*   **ダウンロードボタンが押せない**: 画面のレイアウト変更等によりセレクタが変わっていないか確認してください。ログファイル (`logs/`) に詳細なエラーが出力されます。
