# Gitフックで Node.js のテストを自動実行する（最小構成）

このドキュメントは、**Gitフック（pre-push）を使って Node.js のテストを自動実行する**ための、
最小構成・手順ベースのまとめです。

---

## ゴール

- `git push` を実行した瞬間に
- Node.js のテストが自動で走り
- テストが失敗したら **push が止まる**

---

## 全体の流れ（イメージ）

```
git push
  ↓
pre-push フックが起動
  ↓
node test/logic.test.js 実行
  ↓
OK → push 続行
NG → push 中断
```

---

## 手順① フォルダ構成

```
project/
├─ gas/
│  └─ logic.js        # GASとNodeで共通のロジック
├─ test/
│  └─ logic.test.js   # Node.jsで実行するテスト
└─ .git/
   └─ hooks/
      └─ pre-push     # Gitフック（自動実行される）
```

> `.git/hooks` 配下のファイルは、Gitが自動的に実行します。

---

## 手順② テスト対象のロジックを書く

```js
// gas/logic.js
function double(values) {
  return values.map(v => v * 2);
}

// Node.js から使えるように公開
if (typeof module !== 'undefined') {
  module.exports = { double };
}
```

### 何をしているか

- `double` という関数を定義
- 配列の各要素を2倍にするロジック
- `module.exports` は **Node.js 用**（GASでは無視される）

---

## 手順③ Node.js のテストを書く

```js
// test/logic.test.js
const { double } = require('../gas/logic');

console.assert(
  JSON.stringify(double([1, 2, 3])) === JSON.stringify([2, 4, 6]),
  '❌ double の結果が違う'
);

console.log('✅ ロジックテストOK');
```

### ここでやっていること

- `logic.js` から `double` を読み込む
- 想定した結果と一致するか確認
- NGならエラー、OKならメッセージ表示

---

## 手順④ 手動でテストを実行する（重要）

まずは Gitフックを使わず、**直接 Node.js で実行**します。

```bash
node test/logic.test.js
```

### 実行結果

- 成功時
  ```
  ✅ ロジックテストOK
  ```

- 失敗時
  ```
  Assertion failed: ❌ double の結果が違う
  ```

> ここが動かない場合、Gitフックでも動きません。

---

## 手順⑤ Gitフック（pre-push）を書く

### ファイル作成

```
.git/hooks/pre-push
```

### 中身

```sh
#!/bin/sh
node test/logic.test.js || exit 1
```

### 実行権限を付与（必須）

```bash
chmod +x .git/hooks/pre-push
```

### この1行の意味

```sh
node test/logic.test.js || exit 1
```

- テストを実行
- 失敗したら `exit 1`
- Git は異常終了を検知して push を中断

---

## 手順⑥ git push で動作確認

```bash
git push
```

### 動作

- テスト成功 → push 続行
- テスト失敗 → push 中断（リモートに送られない）

---

## ここまででできるようになったこと

- Git操作に自動チェックを差し込めた
- 壊れたロジックを push 前に検知できる
- CI（GitHub Actions）より手前で止められる

---

## 補足：よくある誤解

- Gitフックは難しい仕組みではない
- 中身は「node を1行実行しているだけ」
- GAS全体をテストする必要はない
- **守りたいロジックだけ守れれば十分**

---

## 次に進むとしたら

- husky を使って Gitフックをリポジトリ管理する
- テストを `npm test` にまとめる
- 既存GASを「ロジック / I/O」で分解する

このドキュメントは、いつでも再開できるように
**最小で・一直線の手順**にしています。

