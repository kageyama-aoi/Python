# `test_main.py` 改善計画書 (2026-01-19)

このドキュメントは、`test_main.py` の保守性とデバッグの容易性を向上させるための改善計画を提案するものです。

---

## 目的

テストコード自体の可読性と情報量を向上させることで、将来的にバグが発生した際に、その原因特定を迅速かつ容易にすることを目指します。

---

## 改善提案

### 1. ロギングの導入による可視性の向上

-   **現状**:
    -   テストが成功したか失敗したかという結果しか分からず、テスト実行中の内部状態を追跡することが困難です。
-   **改善案**:
    -   Python標準の `logging` モジュールをテストコードに導入します。
    -   テストのセットアップ (`setUp`)、クリーンアップ (`tearDown`)、各テストメソッドの実行前後、UIリロード処理の前後など、キーとなるポイントでログを出力します。
    -   これにより、テストの実行フローや、どの段階で問題が発生しているのかを時系列で追跡できるようになります。

### 2. カスタムアサーションの作成による可読性とデバッグ情報の向上

-   **現状**:
    -   `self.assertIsNone(self.find_button_recursively(...))` のようなアサーション（検証）は、コードの意図が直感的に分かりにくいです。
    -   また、アサーションが失敗した際に得られる情報が「`None` ではありませんでした」といった限定的なものに留まります。
-   **改善案**:
    -   テストクラスに、より目的が明確なカスタムアサーションメソッドを追加します。
        -   `assertButtonExists(button_text)`: 指定されたテキストを持つボタンが存在することを検証します。
        -   `assertButtonNotExists(button_text)`: 指定されたテキストを持つボタンが存在しないことを検証します。
    -   これらのメソッドは、失敗時により詳細なデバッグ情報を提供するように実装します。例えば、「期待したボタン 'X' は見つかりませんでしたが、実際にはボタン 'Y' と 'Z' が存在しました」といった情報を出力することで、問題の原因究明を助けます。

### 3. テストデータの外部ファイル化

-   **現状**:
    -   `test_dynamic_ui_reload` のようなテストでは、テストコード内で `copy.deepcopy` を用いて設定データを動的に変更しています。これにより、テストの前提条件がコード内に埋め込まれてしまっています。
-   **改善案**:
    -   `tests/` ディレクトリ内に、テストシナリオごとの設定ファイル（例: `test_config_initial.json`, `test_config_modified.json`）を静的なファイルとして配置します。
    -   テストでは、これらのファイルを直接読み込んで使用するように変更します。
    -   これにより、テストの前提条件（入力データ）がコードから分離され、テストの意図がより明確になります。

### 4. (任意) `setUp` と `tearDown` の改善

-   **現状**:
    -   `setUp` メソッド内で、全てのテストに対して一律に `ConfigManager` のモック（模擬オブジェクト）を作成しています。
-   **改善案**:
    -   `setUp` で一括してモックを作成する代わりに、各テストメソッド内で `with patch(...)` 句を使用することで、テストごとの独立性をさらに高めることができます。
    -   **注**: 現状では全てのテストがモックを必要としているため、この改善の優先度は比較的低いです。

---

## 推奨される次のステップ

まずは、最も効果が大きいと考えられる「**1. ロギングの導入**」と「**2. カスタムアサーションの作成**」に着手し、現在の `test_dynamic_ui_reload` の問題解決に役立てることを推奨します。
